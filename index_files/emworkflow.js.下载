var uploadfields = "";
var dd_corpId = "";//ding00329d6c870d85fe
var _requestid = "";
var myScroll;
var jsfileupload = false;
var jsapitype = "";
var _requestname = "";
var _isshowding = 0;//是否开启盯功能
var _str_name = "盯";
var _outsysid = "";//外部系统ID 主要用于钉钉中图片预览时传递此参数

var _voicet = "#2A7EE7";
var _voicew = 55;
var _voiceh = 55;

var canWxShare = false;

var ddobj = null;
var onlyCamera = false;

var hrmBrowserInit = false;
var hrmFrameInit = false;
var departBrowserInit = false;
var departFrameInit = false;

var departBrowserInit_lp = false;
var departFrameInit_lp = false;

var isFileDownloading = false;

//document.write("<script type=\"text/javascript\" src=\""+wxcontextpath+"/wxjsapi?"+new Date()+"\"></script>");
//document.write("<script type=\"text/javascript\" src=\""+wxcontextpath+"/main/assets/js/touch-0.2.14.js\"></script>");
//document.write("<script type=\"text/javascript\" src=\""+wxcontextpath+"/main/assets/js/jsapifunc.js\"></script>");
jQuery(document).ready(function(){
	//js错误提示
	/*window.onerror = function(msg,url,line){
		alert(msg+"-"+line+"-"+url);
	}*/
	try {
		if (jQuery("#dingtalk").length > 0 || jQuery("#wxjsapi").length > 0) {
			try{
				if (jQuery("#dingtalk").length > 0) {
					_requestid = jQuery("#dingtalk").attr("_requestid");
				} else if (jQuery("#wxjsapi").length > 0) {
					_requestid = jQuery("#wxjsapi").attr("_requestid");
				}
				
				$.ajax({
					url: wxcontextpath+"/mobile/plugin/plus/workflow/data/workflowOperation.jsp",
					data : {
						"operation" : "getRequestName",
						"requestid" : _requestid
					},
					dataType : "json",
					async : false,
					success : function(data) {
						if(data.status==0){
							if(data.requestname){
								_requestname = data.requestname;
							}
							if(_requestname==""){
								_requestname = "流程分享";
							}
						}
					}
				});
			}catch(e){
				
			}
		}
		
		//wxcontextpath = jQuery("#wxcontextpath").val();
		if(wxcontextpath==null || typeof(wxcontextpath)=="undefined") wxcontextpath = "";

//***********************************开启附件上传处理 start****************************************
if (_isForbiddenEbridgeFileupload == 0) {
		
		// Android关闭JSAPI附件上传
		if (typeof (_androidfileupload) != "undefined" && _androidfileupload == "2") {
			if (browser.versions.android || browser.versions.WindowsWechat) {
				jsfileupload = true;
			}
		}
		
		// IOS关闭JSAPI附件上传
		if (typeof (_iosfileupload) != "undefined" && _iosfileupload == "2") {
			if (browser.versions.ios) {
				jsfileupload = true;
			}
		}
		
		/*if(typeof(_waterMarker)!="undefined" && _waterMarker!=null && _waterMarker!=""){
			//alert(_waterMarker);
			jQuery("body").css("cssText","background:url("+_waterMarker+") !important");
		}*/
		
		var _isuploadvoice = 0;
		if(jQuery("#wxjsapi").length>0) _isuploadvoice = jQuery("#wxjsapi").attr("_isuploadvoice");
		//流程附件上传处理
		jQuery("td[name='appendixEditField']").each(function(i){
			// QC443051
			if (jQuery(this).attr("onclick").indexOf("addAppendix_temp") != -1) {
				onlyCamera = true;
			}
			
			//QC:922116
			var workflowid = jQuery("input[name=workflowid]").val();
			if(typeof onlyCameraWfId != undefined && onlyCameraWfId.indexOf(","+workflowid+",")>-1){
				onlyCamera = true;
			}
			jQuery(this).css("width","100%").attr("onclick","");
			var fieldobj = jQuery(this).children("input:first");
			if(fieldobj.length==0){
				fieldobj = jQuery(this).next("td").next("td").children("input:first");
			}
			if(fieldobj.length==0){
				try{//20210413 zhw 针对光大证券客户td位置不对以及图标样式不对问题处理
					fieldobj = jQuery(this).prev("td").prev("td").children("input:first");
					$(this).insertAfter($(this).parent());
					$(this).children("a:first").children("div:first").css({
						"background":"url(/images/search_icon_wev8.png)",
						"width":"30px",
						"height":"30px"
					});
				}catch(e){
					
				}
			}
			var fieldid = fieldobj.attr("id");
			if(fieldid!="" && fieldid!=null && typeof(fieldid)!="undefined"){
				if(fieldid.indexOf("cnt")==0) fieldid = fieldid.substring(3);
				
				jQuery("input[name='ismandfield']").each(function() {
					if(this.value==fieldid){
						jQuery("#"+fieldid).attr("ismandfield","1");
					}
				});
				
				uploadfields += "," + fieldid;
				
				jQuery(this).children("a").addClass("addFileBtn").bind("click",function(){
					addFile(fieldid);
				});
				
				var filestr = "<input type=\"hidden\" id=\"file"+fieldid+"_index\" name=\"file"+fieldid+"_index\" _fieldid=\""+fieldid+"\" value=\"0\"/>"
					+"<div id=\"fileshow"+fieldid+"\" name=\"fileshow"+fieldid+"\" _fieldid=\""+fieldid+"\"></div>"
					+"<div id=\"filehide"+fieldid+"\" class=\"filehidediv\" style=\"display:none\"></div>"
					+"<input type=\"hidden\" id=\"filedel"+fieldid+"\" name=\"filedel"+fieldid+"\" _fieldid=\""+fieldid+"\" value=\"\"/>";
				
				//filestr += "<input style=\"\" type=\"file\" id=\"file\" name=\"file\"  />";
				
				//增加jsapi图片上传
				filestr +="<div id=\"photoBtn"+fieldid+"\" _fieldid=\""+fieldid+"\" class=\"photoBtn\" style=\"background-image:url('"+wxcontextpath+"/main/assets/img/search_icon.png');width: 30px;height:30px;margin-left: 0px;display:none;\"></div>";
				filestr +="<div id=\"photoRenderTo"+fieldid+"\" class=\"photoRenderTo\" style=\"margin-top: 0px;margin-right: 10px; padding: 0px; border: 0px #EEE solid; min-height: 0px;display:none;\"></div>";
				filestr +="<input type=\"hidden\" id=\"filephoto"+fieldid+"\" name=\"filephoto"+fieldid+"\" class=\"filephotoids\" _fieldid=\""+fieldid+"\" value=\"\"/>";
				
				//filestr += "<input style=\"\" type=\"file\" id=\"file\" name=\"file\"  />";
				
				// 云之家上传文件
				filestr += "<div id=\"jdyzj_photoBtn"+fieldid+"\" _fieldid=\""+fieldid+"\" class=\"jdyzj_photoBtn\" style=\"background-image:url('"+wxcontextpath+"/main/assets/img/search_icon2.png');width: 30px;height:30px;margin-left: 3px;display:none;\"></div>";
				filestr += "<div id=\"jdyzj_fileshow"+fieldid+"\"></div>";
				filestr += "<input type=\"hidden\" id=\"jdyzj_fileIds"+fieldid+"\" class=\"jdyzj_fileIds\" _fieldid=\""+fieldid+"\">";
				
				//增加语音输入
				if(_isuploadvoice==1){
					filestr +="<div id=\"voiceBtn"+fieldid+"\" _fieldid=\""+fieldid+"\" class=\"voiceBtn\" style=\"background-image:url('"+wxcontextpath+"/main/assets/img/voice_icon.png');width: 30px;height:30px;margin-left: 0px;display:none;\"></div>";
					filestr +="<div id=\"voiceRenderTo"+fieldid+"\" class=\"voiceRenderTo\" style=\"margin-top: 0px;margin-right: 10px; padding: 0px; border: 0px #EEE solid; min-height: 0px;display:none;\"></div>";
					filestr +="<input type=\"hidden\" id=\"filevoice"+fieldid+"\" name=\"filevoice"+fieldid+"\" class=\"filevoiceids\" _fieldid=\""+fieldid+"\" value=\"\"/>";
				}
				
				jQuery(this).attr("id","fileuploadtd_"+fieldid).append(filestr);
				addInputEl(fieldid);
				
				if(_isuploadvoice==1){
					try{
						// 上传录音
						$("#voiceBtn"+fieldid).wxUploadVoice({
							contextPath: wxcontextpath, // 默认上下文路径为"/"
							direction: "right", // 录音面板显示的位置，默认top，表示在voiceBtn按钮的上方，可选项：top、right、bottom、left
							renderTo : "voiceRenderTo"+fieldid, // 使用默认样式将语音播放按钮绘制到id为voiceRenderTo的元素中，如果不配置，可在回调函数中自定义绘制语音播放按钮
							width : "55", // 默认样式中语音播放按钮的宽度，单位px，默认60px
							height : "55", // 默认样式中语音播放按钮的高度，单位px，默认60px
							theme : "#2A7EE7", // 默认样式中语音播放按钮的主题颜色，默认蓝色（#2A7EE7）
							rtheme : "#2A7EE7" // 默认样式中录音面板的主题颜色，默认蓝色（#2A7EE7）
						}, function(fileIds, renderHtml) {
							// fileIds 为本地文件id列表，以英文,分隔，（本地文件id即wx_base_file的主键id值）
							// renderHtml 语音播放按钮的默认html
							var filevoice = jQuery("#filevoice"+fieldid).val();
							if(filevoice=="") filevoice = fileIds;
							else filevoice += "," + fileIds;
							jQuery("#filevoice"+fieldid).val(filevoice);
							setMust(fieldid);
						});
					}catch(e){
						//alert(e);
					}
				}
				
				//钉钉中附件上传采用jsapi图片上传方式
				if(jQuery("#dingtalk").length>0 || jQuery("#wxjsapi").length>0){
					try{
						var finalSourceType = 0;
						if (onlyCamera) {
							finalSourceType = 2;
						} else if (typeof ebChooseImageFromLocal != "undefined") {// QC621922
							if (ebChooseImageFromLocal != "1") {
								finalSourceType = 2;
							}
						} else if (typeof chooseImageSourceType != "undefined") {
							finalSourceType = chooseImageSourceType;
						}
						
						// 上传照片
						$("#photoBtn"+fieldid).wxChooseImage({
							contextPath: wxcontextpath, // 默认上下文路径为"/"
							renderTo : "photoRenderTo"+fieldid, // 使用默认样式将图片预览绘制到id为imageRenderTo的元素中，如果不配置，可在回调函数中自定义绘制图片预览
							sourceType : finalSourceType, // 可以指定来源是相册还是相机，默认二者都有，1：只用相册，2：只用相机
							width : "70", // 默认样式中预览图片的宽度，单位px，默认60px
							height : "70" // 默认样式中预览图片的高度，单位px，默认60px
						}, function(fileIds, renderHtml) {
							// fileIds 为本地文件id列表，以英文,分隔，（本地文件id即wx_base_file的主键id值）
							// renderHtml 图片预览的默认html
							$("#photoRenderTo"+fieldid).addClass("image-items");
							var filephoto = jQuery("#filephoto"+fieldid).val();
							if(filephoto=="") filephoto = fileIds;
							else filephoto += "," + fileIds;
							jQuery("#filephoto"+fieldid).val(filephoto);
							setMust(fieldid);
							//$("#photoRenderTo"+fieldid).find(".wxRemoveImage").remove();
						});
						
					}catch(e){
						//alert(e);
						jsfileupload = false;
					}
				} else if (jQuery("#jdyzjjsapi").length > 0) {
					$("#jdyzj_photoBtn"+fieldid).click(function() {
						XuntongJSBridge.call('selectFile', {"pLink": "true", "type": "1"}, function(result) {
							var success = String(result.success);
							if (success == "true") {
								var files = result.data.files;
								for (var i = 0; i < files.length; i++) {
									var file = files[i];
									$.ajax({
										url : wxcontextpath + "/wxjsapi/saveYZJFile",
										type : "post",
										data : {
											"fileId" : file.fileId,
											"fileName" : file.fileName,
											"downloadUrl" : file.downloadUrl,
											"fileExt" : file.fileExt
										},
										dataType : "json",
										async : false,
										success : function(data) {
											if (data.status == "error") {
												alert(data.msg);
											} else {
												var jdyzj_fileIds = jQuery("#jdyzj_fileIds"+fieldid).val();
												if (jdyzj_fileIds != "") {
													jdyzj_fileIds += ",";
												}
												jdyzj_fileIds += data.id;
												jQuery("#jdyzj_fileIds"+fieldid).val(jdyzj_fileIds);
												
												jQuery("#jdyzj_fileshow"+fieldid).append("<div id=\"jdyzj_fileshowitem"+data.id+"\" class=\"jdyzj_fileitem"+fieldid+"\" style=\"line-height:28px;overflow:hidden\">"
														+"<div style=\"float:left;font-size:14px;\">"+file.fileName+"</div>"
														+"<div style=\"float:left;width:24px;height:24px;line-height:24px;margin-left:6px;text-align:center;"
														+ "font-size:20px;font-weight:bold;border-radius:12px;background:#F8F7F3\""
														+ " onclick=\"delJZYZJFile('" + data.id + "','" + fieldid + "')\">×</div>"
														+"</div>");
												
												setMust(fieldid);
											}
										},
										error : function() {
											//alert("网络异常");
										}
									});
								}
							} else if (success == "false") {
								if (result.error != "用户取消") {
									alert(result.error);
								}
							} else {
								alert("接口返回值非法！");
							}
						});
					});
				}
				//处理编辑时已有的附件
				var spantd = jQuery("#"+fieldid+"_span");
				if(spantd.length>0){
					spantd.children("div").each(function(){
						var spandiv = jQuery(this);
						var appdixid = spandiv.attr("id");
						var canDelete = spandiv.attr("canDelete");
						if(appdixid.indexOf("appDix_")==0){
							var fdocid = appdixid.substring(7);
							var namespan = spandiv.find("span:first");
							spandiv.find("br").remove();
							spandiv.height("auto").css({"line-height":"28px","overflow":"hidden"});
							if(canDelete!=0){
								namespan.after("<span style=\"display:inline-block;margin-left:6px;width:24px;height:24px;line-height:24px;text-align:center;font-size:20px;border-radius:12px;font-weight:bold;background:#F8F7F3;cursor:pointer;\""
										+" onclick=\"updateDelFile(this,'"+fieldid+"','"+fdocid+"')\" _status=\"0\">×</span>");
							}
							jQuery("#fileshow"+fieldid).append(spandiv);
						}
					});
				}
			}
		});
		
		if(uploadfields!="") uploadfields = uploadfields.substring(1);
		
		try{
			if(navigator.userAgent.indexOf("Mobile")>-1 || navigator.userAgent.indexOf("mobile")>-1) jQuery("a.addFileBtn").hide();
		}catch(e){}
		
}
//***********************************开启附件上传处理 end****************************************
		
		//钉钉功能处理
		if(jQuery("#dingtalk").length>0){
			//
			/*dd.config({
				"corpId":"ding00329d6c870d85fe"
				,"appId":"456316"
				,"timeStamp":"1441525607"
				,"nonceStr":"5b47526d-1bb4-474d-a9a4-be32df237367"
				,"signature":"ae198e79303beafa7811ca16adffc6d274100827"
				,"jsApiList":["dd.device.geolocation.get"]
			});*/
			/*try{
				dd.config({"corpId":"ding00329d6c870d85fe","timeStamp":"1441797218","appId":"456316","nonceStr":"56a3601d-7397-4ffd-a05c-823369482638","signature":"83b40f22e3100ff21ced0bb4924a77adbd568234","jsApiList":["device.notification.alert","device.notification.confirm","device.notification.prompt","device.notification.vibrate","device.accelerometer.watchShake","device.accelerometer.clearShake","biz.util.open","biz.util.openLink","biz.util.share","biz.util.ut","biz.util.datepicker","biz.util.timepicker","biz.contact.choose","biz.navigation.setLeft","biz.navigation.setRight","biz.navigation.setTitle","biz.navigation.back","device.notification.toast","device.notification.showPreloader","device.notification.hidePreloader","device.geolocation.get","biz.util.uploadImage","biz.util.previewImage","ui.input.plain","device.notification.actionSheet","biz.util.qrcode","device.connection.getNetworkType","runtime.info","biz.ding.post","biz.telephone.call","biz.contact.createGroup","biz.util.datetimepicker","biz.util.chosen","device.base.getUUID","device.base.getInterface","device.launcher.checkInstalledApps","device.launcher.launchApp","ui.progressBar.setColors","runtime.permission.requestAuthCode","ui.pullToRefresh.enable","ui.pullToRefresh.stop","ui.pullToRefresh.disable","ui.webViewBounce.enable","ui.webViewBounce.disable","biz.util.scan","biz.contact.complexChoose","biz.chat.pickConversation","device.notification.modal","biz.navigation.setIcon","biz.util.uploadImageFromCamera"]});
			}catch(e){
				alert(e);
			}*/
			
			jsapitype = "dd";
			dd_corpId = jQuery("#dingtalk").attr("_ddcorpid");
			_isshowding = jQuery("#dingtalk").attr("_isshowding");
			_outsysid = jQuery("#dingtalk").attr("_outsysid");
			if (typeof dd != "undefined") {
				if (typeof parent.dd != "undefined") dd = parent.dd;
				dd.ready(function(){
					//alert(dd_corpId);
				    // 须把相关接口放在ready函数中调用来确保正确执行
				    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
					
					ddobj = dd;
					
					//初始盯功能
					if(_requestid!="" && _isshowding==1) initDingMenu();
					
					//***********************************开启附件上传处理 start****************************************
					if (_isForbiddenEbridgeFileupload == 0) {
						if(jsfileupload){
							jQuery("a.addFileBtn").hide();
							jQuery("div.photoBtn,div.photoRenderTo").show();
						}else{
							jQuery("a.addFileBtn").show();
						}
						
						//附件图片缩略图及预览
						//if(_requestid!="") dealFileView();
					}
					//***********************************开启附件上传处理 end****************************************
				});
				dd.error(function(error){
					//***********************************开启附件上传处理 start****************************************
					if (_isForbiddenEbridgeFileupload == 0) {
						jQuery("a.addFileBtn").show();
					    /*alert(error.errorCode+"-"+error.message);
					    for(var key in error){  
			               // alert(key);  
			            }*/
					}
					//***********************************开启附件上传处理 end****************************************
				});
			} else {
				//***********************************开启附件上传处理 start****************************************
				if (_isForbiddenEbridgeFileupload == 0) {
					jQuery("a.addFileBtn").show();
				}
				//***********************************开启附件上传处理 end****************************************
			}
			
			if (typeof DingTalkPC != "undefined") {
				try{
					if (typeof parent.DingTalkPC != "undefined") DingTalkPC = parent.DingTalkPC;
				}catch(e){
					
				}
				DingTalkPC.ready(function(res){
					//初始盯功能
					if(_requestid!="" && _isshowding==1) {
						jsapitype = "dd_pc";
						ddobj = DingTalkPC;
						initDingMenu();
					}
				});
			}
		}
		
		else if(jQuery("#wxjsapi").length>0){
			
			jsapitype = "wx";
			dd_corpId = jQuery("#wxjsapi").attr("_wxcorpid");
			_isshowding = jQuery("#wxjsapi").attr("_isshowding");
			_outsysid = jQuery("#wxjsapi").attr("_outsysid");
			
			if (typeof wx != "undefined") {
				if (typeof parent.wx != "undefined") wx = parent.wx;
				
				wx.ready(function(){
				    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
					try{
						wx.checkJsApi({
						    jsApiList: ['openEnterpriseChat','chooseImage','uploadImage','previewImage','uploadVoice','onMenuShareAppMessage'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
						    success: function(res) {
						    	//初始盯功能
						    	if(_requestid!="" && _isshowding==1 && res.checkResult.openEnterpriseChat)
						    		initDingMenu();
						    	
						    	//***********************************开启附件上传处理 start****************************************
								if (_isForbiddenEbridgeFileupload == 0) {
							    	if(res.checkResult.chooseImage && res.checkResult.uploadImage && jsfileupload){
							    		jQuery("a.addFileBtn").hide();
										jQuery("div.photoBtn,div.photoRenderTo").show();
							    	}else{
							    		jQuery("a.addFileBtn").show();
							    	}
								}
								//***********************************开启附件上传处理 end****************************************
						    	
						    	//alert(res.checkResult.uploadVoice+'--'+_isuploadvoice);
						    	if(res.checkResult.uploadVoice && _isuploadvoice==1){
						    		jQuery("div.voiceBtn,div.voiceRenderTo").show();
						    	}
						    	if(res.checkResult.onMenuShareAppMessage){
						    		try{
						    			if(_isForbiddenEbridgeShareFunction == "0" && typeof ShareApp_Sign == "undefined"){
						    				//修改微信分享
											wx.onMenuShareAppMessage({
								    		    title: _requestname, // 分享标题
								    		    desc: "点击查看流程："+_requestname, // 分享描述
								    		    //link: '', // 分享链接
								    		    imgUrl: _outurl + '/main/portal/images/tp6.png', // 分享图标
								    		    type: '', // 分享类型,music、video或link，不填默认为link
								    		    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
								    		    success: function () {
								    		        // 用户确认分享后执行的回调函数
								    		    },
								    		    cancel: function () {
								    		        // 用户取消分享后执行的回调函数
								    		    }
								    		});
						    			}
									}catch(e){
										
									}
						    	}
						    	
						    	//附件图片缩略图及预览
						    	//if(_requestid!="" && res.checkResult.previewImage)
						    	//	dealFileView();
						    },
						    fail: function(error) {
								//***********************************开启附件上传处理 start****************************************
								if (_isForbiddenEbridgeFileupload == 0) {
									jQuery("a.addFileBtn").show();
								}
								//***********************************开启附件上传处理 end****************************************
						    	//alert(error.errMsg)
						    	/*for(var key in error){  
						               alert(key);  
						            }*/
						    }
						    // 以键值对的形式返回，可用的api值true，不可用为false
						    // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
						});
					}catch(e){
						//***********************************开启附件上传处理 start****************************************
						if (_isForbiddenEbridgeFileupload == 0) {
							jQuery("a.addFileBtn").show();
						}
						//***********************************开启附件上传处理 end****************************************
					}
				});
				
				wx.error(function(e){
					//***********************************开启附件上传处理 start****************************************
					if (_isForbiddenEbridgeFileupload == 0) {
						jQuery("a.addFileBtn").show();
					}
					//***********************************开启附件上传处理 end****************************************
				});
			} else {
				//***********************************开启附件上传处理 start****************************************
				if (_isForbiddenEbridgeFileupload == 0) {
					jQuery("a.addFileBtn").show();
				}
				//***********************************开启附件上传处理 end****************************************
			}
		} else if (jQuery("#jdyzjjsapi").length > 0) {
			//***********************************开启附件上传处理 start****************************************
			if (_isForbiddenEbridgeFileupload == 0) {
				if (useJDYZJFile == 0) {
					jQuery("a.addFileBtn").show();
					jQuery("div.jdyzj_photoBtn").hide();
				} else if (useJDYZJFile == 1) {
					jQuery("a.addFileBtn").hide();
					jQuery("div.jdyzj_photoBtn").show();
				} else if (useJDYZJFile == 2) {
					jQuery("a.addFileBtn").show();
					jQuery("div.jdyzj_photoBtn").show();
				}
			}
			//***********************************开启附件上传处理 end****************************************
		} else {
			//***********************************开启附件上传处理 start****************************************
			if (_isForbiddenEbridgeFileupload == 0) {
				jQuery("a.addFileBtn").show();
			}
			//***********************************开启附件上传处理 end****************************************
		}
		//setTimeout(function(){//zhw 20190227修改 不要立即加载选人和选部门组件
			//initHrmBrowser();
			//initDepartBrowser();
		//},3000);
		doHideOpBtn();
		//TODO 测试注释
		//***********************************开启附件上传处理 start****************************************
		if (_isForbiddenEbridgeFileupload == 0) {
			dealFileView();
		}
		//***********************************开启附件上传处理 end****************************************
		//initFileFrame();
	}catch(e){
		//alert("附件上传初始化失败！"+e);
	}
});

//处理流程附件自动，图片增加预览，语音增加播放
var imgurls = [];
var photoScrollTop = 0;
function dealFileView(){
	jQuery("div").each(function(){
		var spandiv = jQuery(this);
		var appdixid = spandiv.attr("id");
		if(typeof(appdixid)=="undefined") appdixid = "";
		if(appdixid.indexOf("appDix_")==0){
			var namespan = spandiv.find("span:first");
			var fdocname = namespan.html();
			if(/.+\.(png|jpe?g|gif).+/i.test(fdocname)){
				var ffid = spandiv.html();
				var tempindex = ffid.indexOf("toDownload('");
				if(tempindex>-1){
					ffid = ffid.substring(tempindex+12);
					tempindex = ffid.indexOf("'");
					if(tempindex>-1) ffid = ffid.substring(0,ffid.indexOf("'"));
					else ffid = "";
				}else{
					ffid="";
				}
				if(ffid!=""){
					var _url = wxcontextpath+"/weaver/weaver.file.FileDownload?fileid="+ffid+"&outsysid="+_outsysid;
					if (imgurls.indexOf(_outurl + _url) == -1) {
						imgurls.push(_outurl + _url);
					}
					if(_photopreviewtype=="2"){
						//显示预览按钮
						if (typeof wx != "undefined" || (typeof ddobj != "undefined" && ddobj!=null)) {
							namespan.after("<span class=\"img_wxPreviewSpan\" style=\"margin-left:5px;color:rgb(0, 128, 192);text-decoration:underline\" _src=\""+_url+"\">预览</span>");
						}
					} else if(_photopreviewtype=="1"){
						//显示缩略图
						namespan.before("<div><img class=\"img_wxPreviewImage\" src=\""+_url+"\" style=\"width:70px;height:70px;cursor:pointer;\"/></div>");
					}
				}
			}else if(fdocname.indexOf(".mp3")>-1){
				var ffid = spandiv.html();
				var tempindex = ffid.indexOf("toDownload('");
				if(tempindex>-1){
					ffid = ffid.substring(tempindex+12);
					tempindex = ffid.indexOf("'");
					if(tempindex>-1) ffid = ffid.substring(0,ffid.indexOf("'"));
					else ffid = "";
				}else{
					ffid="";
				}
				if(ffid!=""){
					
					var voicebtn = "<div class=\"_audiodiv\" onclick=\"playAudio(this)\" _play=\"0\" style=\"width: "+_voicew+"px; height: "+_voiceh+"px; border: 1px "+_voicet+" solid;margin-left:4px;cursor:pointer;\">" 
					+ "<audio class=\"_audio\">"
					+"<source src=\""+wxcontextpath+"/weaver/weaver.file.FileDownload?fileid="+ffid+"&outsysid="+_outsysid+"\" type=\"audio/mpeg\">"
					+"</audio>"
					+ "<div class=\"wxVoicePlayWrapper\" style=\"width: 30px; height: 30px; border-width: 4px; border-color: transparent " + _voicet + " transparent transparent; border-style: solid; border-radius: 30px; display: inline-block; margin-top: " + (_voiceh - 38)/2 + "px; margin-left: 0px;\">"
					+ "<div class=\"wxVoicePlayMiddle\" style=\"width: 18px; height: 18px; border-width: 4px; border-color: transparent " + _voicet + " transparent transparent; border-style: solid; border-radius: 18px; margin: 2px;\">"
					+ "<div class=\"wxVoicePlayInner\" style=\"width: 0px; height: 0px; border-width: 8px 8px 8px 0px; border-color: transparent " + _voicet + " transparent transparent; border-style: solid; border-top-right-radius: 8px; border-bottom-right-radius: 8px; margin: 1px 1px 1px 8px;\">"
					+"</div></div></div></div>";
					namespan.before(voicebtn);
				}
			}
			namespan.css({"color":"#0080C0","text-decoration":"none"});
			namespan.before("<img style='width:14px;height:14px;margin-bottom:-2px;' src=\""+wxcontextpath+"/main/assets/images/file.png\" />");
			spandiv.css({"margin-top":"5px"}).find("br").remove();
		}
	});
	if(_photopreviewtype=="2"){
		//预览按钮点击事件
		jQuery(".img_wxPreviewSpan").live("click", function() {
			wxPreviewImage(jQuery(this), jQuery(this).attr("_src"));
		});
	} else {
		//缩略图点击事件
		jQuery(".img_wxPreviewImage").live("click", function() {
			wxPreviewImage(jQuery(this), jQuery(this).attr("src"));
		});
	}
	
	
	jQuery("._audiodiv").each(function(){
		var $this = $(this);
		var _audio = $this.children("audio")[0];
		var vpm = $this.find(".wxVoicePlayMiddle"),
			vpw = $this.find(".wxVoicePlayWrapper");
		//alert(_audio.duration);
		//_audio.play();
		_audio.addEventListener("ended", function() {
			if ($this.attr("_play") == "1") {
				clearInterval(_interVpm);
				_interVpm = null;
				vpm.css("border-color", "transparent " + _voicet + " transparent transparent");
				vpw.css("border-color", "transparent " + _voicet + " transparent transparent");
				_mshow = _wshow = 1;
				$this.attr("_play", "0");
			}
	    }, false)
	});
	
	//setTimeout(function(){
		
	//},5000);
		/*jQuery("audio").bind("ended",function() {
		    alert("音频播放完成");
		});
		
		setInterval(function() {
			jQuery("audio").each(function(){
				
				alert(this.ended);
				//_audio.play();
			});
		},5000);*/
}
var _interVpm,_mshow,_wshow,_timeoutVpm;
function playAudio(obj) {
	var $this = $(obj);
	var vpm = $this.find(".wxVoicePlayMiddle"),
		vpw = $this.find(".wxVoicePlayWrapper");
	
	 
	if (_interVpm) {
		clearInterval(_interVpm);
		_interVpm = null;
		_mshow = _wshow = 1;
		
		var play = $("div[_play='1']");
		play.not($this).attr("_play", "0");
		play.find(".wxVoicePlayMiddle").css("border-color", "transparent " + _voicet + " transparent transparent");
		play.find(".wxVoicePlayWrapper").css("border-color", "transparent " + _voicet + " transparent transparent");
		
		// 停止播放
		$this.children("audio")[0].pause();
		
		if ($this.attr("_play") == "1") {
			$this.attr("_play", "0");
			return;
		}
	}
	
	$this.attr("_play",1);
	_interVpm = setInterval(function() {
		if (_mshow == 1 && _wshow == 1) {
			vpm.css("border-color", "transparent");
			vpw.css("border-color", "transparent");
			_mshow = _wshow = 0;
		} else {
			_mshow = 1;
			vpm.css("border-color", "transparent " + _voicet + " transparent transparent");
		}
		
		_timeoutVpm = setTimeout(function() {
			if (_mshow == 1) {
				_wshow = 1;
				vpw.css("border-color", "transparent " + _voicet + " transparent transparent");
				clearTimeout(_timeoutVpm);
			}
		}, 200);
	}, 500);
	$this.children("audio")[0].play();
	
	/*var _play = jQuery(obj).attr("_play");
	if(_play==0){
		
		
	}else{
		jQuery(obj).children("audio")[0].pause();
		jQuery(obj).attr("_play",0);
	}*/
}

function doHideOpBtn(){
	var initHandWrite = false;
	jQuery("div").each(function(){
		var content = jQuery(this).html();
		if(content=="语音附件"){//content=="手写签批" || 
			jQuery(this).parent("div").width("auto").height("auto");
			jQuery(this).next("div").hide();
			jQuery(this).hide();
		}else if(content=="手写签批"){
			jQuery(this).parent("div").width("auto").height("auto");
			jQuery(this).css({"color":"#000","background":"none","cursor":"pointer","width":"auto","min-width":"60px","padding-left":"4px","padding-right":"4px"}).bind("click",function(){
				doHandWriteSign();
			});
			initHandWriteFrame();
			initHandWrite = true;
		}else if(content=="电子签章"){
			jQuery(this).parent("div").width("auto").height("auto");
			jQuery(this).css({"width":"auto","min-width":"60px","padding-left":"4px","padding-right":"4px"});
		}
	});
	
	if(!initHandWrite && jQuery("#handWrittenSignLi").length>0){
		initHandWriteFrame();
	}
}
/******************手写签批相关处理************************/
function doHandWriteSign(){
	_scrolltop = jQuery(document).scrollTop();
	jQuery("#handWriteDiv").animate({ "left":"0" },400,null,function(){
		setTimeout(function(){
			jQuery(document).scrollTop(0);
		},500);
	});
}
//初始化手写签批页面
function initHandWriteFrame(){
	_wheight = window.innerHeight;
	_wwidth = window.innerWidth;
	var bstr = "<div id=\"handWriteDiv\" style=\"width:100%;height:"+_wheight+"px;position:fixed;left:"+_wwidth*20+"px;top:0px;bottom:0px;right:0px;background:#fff;overflow:hidden;display: ;z-index:1000;\">"
            + "<iframe id=\"handWriteFrame\" style=\"width:100%;height:"+_wheight+"px;\" src=\""+wxcontextpath+"/main/outsys/signature\" frameborder=\"0\" scrolling=\"auto\"></iframe>"
            + "</div>";
	//jQuery("body").append("<iframe id=\"hrmBrowserFrame\" style=\"width:100%;height:"+_wheight+"px;position:fixed;top:"+_wheight+"px;left:0px;right:0px;background:#fff;overflow:hidden;display: ;\" src=\"/mobile/plugin/plus/browser/hrmBrowser.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>");
	jQuery("body").append(bstr);
	
}
//手写签批回调方法
function onSignatureOk(datapair){
	jQuery("#divHandWrittenSign").remove();
	
	var hws = "<div id=\"divHandWrittenSign\" style='text-align:left;padding:10px;'><img id='handWriteImg' src='"+datapair+"'/>"
		+ "<input type=\"hidden\" id=\"fieldHandWritten\" name=\"fieldHandWritten\" value=\""+datapair.split(",")[1]+"\"/>"
		+ "</div>";
	jQuery("#markImg").parent().before(hws);
	
	try{
		addBackImges(datapair,"data:image/png;base64","userSignRemark");
	}catch(e){}
	
	onSignatureBack();
}
function onSignatureBack(){
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#handWriteDiv").animate({ "left":_wwidth*20 },400,null,function(){});
	
	setRedflag();
}
function onSignatureClear(){
	jQuery("#divHandWrittenSign").remove();
	try{
		removeBackImages("data:image/png;base64","userSignRemark");
	}catch(e){}
	
	onSignatureBack();
}
/******************手写签批相关处理************************/

//执行选择文件
function addFile(_fieldid){
	var _flag = false;
	jQuery("a.addFileBtn").each(function(){
		if(jQuery(this).css("display")!="none"){
			_flag = true;
		}
	});
	if(_flag){
		var _index = parseInt(jQuery("#file"+_fieldid+"_index").val());
		jQuery("#file"+_fieldid+"_"+(_index-1)).click();
	}
}

//添加选择文件的input
function addInputEl(_fieldid){
	var _index = parseInt(jQuery("#file"+_fieldid+"_index").val());
	
	var filestr = "<input style=\"display:\" type=\"file\" id=\"file"+_fieldid+"_"+_index+"\" name=\"file"+_fieldid+"_"+_index+"\" _fieldid=\""+_fieldid+"\" onchange=\"showFile(this,"+_index+")\" />";
	jQuery("#filehide"+_fieldid).append(filestr);
	
	jQuery("#file"+_fieldid+"_index").val(_index+1);
}

//选择文件后执行
function showFile(obj,_index){
	var _fieldid = jQuery(obj).attr("_fieldid");
	var file = obj.files[0];
	var filename = file.name;
	if(filename=="image.jpg" || filename==""){
		var now = new Date(); 
		var nowStr = now.format("yyyyMMddhhmmss");
		filename = "IMG"+nowStr+".jpg";
	}
	jQuery("#fileshow"+_fieldid).append("<div id=\"fileshowname"+_fieldid+"_"+_index+"\" style=\"line-height:28px;overflow:hidden\">"
			+"<div style=\"float:left;font-size:14px;\">"+filename+"</div>"
			+"<div style=\"float:left;width:24px;height:24px;line-height:24px;margin-left:6px;text-align:center;font-size:20px;font-weight:bold;border-radius:12px;background:#F8F7F3\" onclick=\"delFile('"+_fieldid+"','"+_index+"')\">×</div>"
			+"<input type=\"hidden\" id=\"filename"+_fieldid+"_"+_index+"\" name=\"filename"+_fieldid+"_"+_index+"\" class=\"fielditem"+_fieldid+"\" value=\""+filename+"\"/>"
			+"</div>");
	
	addInputEl(_fieldid);
	
	setMust(_fieldid);
}

//删除文件（选择文件后）
function delFile(_fieldid,_index){
	if(confirm("确定删除此文件？")){
		jQuery("#file"+_fieldid+"_"+_index+",#fileshowname"+_fieldid+"_"+_index).remove();
	}
	
	setMust(_fieldid);
}
//附件必填属性处理
function setMust(fieldid){
	//判断附件字段是否为必填
	var ismandfield = jQuery("#"+fieldid).attr("ismandfield");
	var ismandvalue = "";
	try{
		ismandvalue = jQuery("#"+fieldid+"_ismandfield").val();
		if(typeof(ismandvalue)=="undefined") ismandvalue = "";
	}catch(e){}
	
	if(ismandfield=="1" || ismandvalue!=""){
		var _fileval = jQuery("#"+fieldid).val();
		//alert(jQuery(".fielditem"+fieldid).length);
		if(jQuery(".fielditem"+fieldid).length>0 || jQuery(".voiceBtn"+fieldid+"_wxPreviewVoice").length>0
				 || jQuery(".photoBtn"+fieldid+"_wxPreviewImage").length>0
				 || jQuery(".jdyzj_fileitem"+fieldid).length>0){
			if(_fileval=="") _fileval = "0";
		}else{
			if(_fileval=="0") _fileval = "";
		}
		jQuery("#"+fieldid).val(_fileval);
		if(_fileval=="0"){
			$("#"+fieldid+"_ismandspan").hide();
		}else{
			$("#"+fieldid+"_ismandspan").show();
		}
	}
}

//删除已有的文件（处理页面）
function updateDelFile(obj,_fieldid,_fdocid){
	var newdelids = "";
	var filedelids = jQuery("#filedel"+_fieldid).val();
	
	var newids = "";
	var fileids = jQuery("#"+_fieldid).val();
	if(fileids=="0") fileids = "";
	
	var _status = jQuery(obj).attr("_status");
	if(_status==0){
		if(!confirm("确定删除该附件")){
			return;
		}
		//如果标记为删除，删除附件字段值要增加此附件id
		jQuery(obj).parent().css({"display":"none"});//zhw 20180511 修改 隐藏此元素
		jQuery(obj).css({"background":"red","color":"#fff"}).attr("_status",1);
		newdelids = filedelids + "," + _fdocid;
		
		//如果标记为删除，附件字段值需要去除此附件id
		var idarray = fileids.split(",");
		for(var i=0;i<idarray.length;i++){
			var fileid = idarray[i];
			if(fileid!="" && fileid!=_fdocid){
				newids += "," + fileid;
			}
		}
	}else{
		//如果标记为不删除，删除附件字段值中要去除此附件id
		jQuery(obj).css({"background":"#F8F7F3","color":"#000"}).attr("_status",0);
		var idarray = filedelids.split(",");
		for(var i=0;i<idarray.length;i++){
			var delid = idarray[i];
			if(delid!="" && delid!=_fdocid){
				newdelids += "," + delid;
			}
		}
		
		//如果标记为不删除，附件字段值要将增加此附件id
		newids = fileids + "," + _fdocid;
	}
	if(newdelids.indexOf(",")==0) newdelids = newdelids.substring(1);
	if(newids.indexOf(",")==0) newids = newids.substring(1);
	
	//alert(newdelids);
	jQuery("#filedel"+_fieldid).val(newdelids);
	jQuery("#"+_fieldid).val(newids);
	
	setMust(_fieldid);
}
function checkCustomize(){
	return true;
}
//提交
function doUploadSubmit(){
	//***********************************关闭附件上传处理 start****************************************
	if (_isForbiddenEbridgeFileupload != 0) {
		$('#workflowfrm').submit();
		return;
	}
	//***********************************关闭附件上传处理 end****************************************
	
	var formaction = jQuery("#workflowfrm").attr("action");
	try{
		if(uploadfields!="" && jQuery("#src").val() != "forward"){
			//执行上传附件
			var loadstr = "<div id=\"uploading\" style=\"width:100%;position:fixed;top:0px;left:0px;right:0px;bottom:0px;background:#fff;opacity: 0.5;\"></div>"
				+"<div id=\"uploadmsg\" style=\"position:fixed;width:100%;top:200px;left:0px;text-align:center;font-size:18px;color:#000;\">上传附件中...</div>"
			;
			//jQuery("body").append(loadstr);
			//不管是否用JSAPI上传文件时都会走这里处理,使用JSAPI上传的话这里请求返回的是空,提交已有附件的表单,这里会返回附件ID
			jQuery("#workflowfrm").attr("action",wxcontextpath+"/mobile/plugin/plus/fileupload/uploadOperation.jsp?random="+new Date().getTime());
			jQuery("#workflowfrm").ajaxSubmit({
				type : "post",
				data : {"operation":"upload","uploadfields":uploadfields,"fromEb":"1"},
				dataType : "json",
				success : function(data) {
					//alert(data.status);
					//try {data = JSON.parse(data);} catch (e) {alert(data);}
					if(data.status==1){
						try{
						var values = data.docvaluelist;
						if(values!=null && typeof(values)!="undefined"){
							for(var i=0;i<values.length;i++){
								var fieldid = values[i].fieldid;
								var docids = values[i].docids;
								//alert("上面的方法"+values[i].fieldid+"--"+values[i].docids);
								jQuery("#"+fieldid).val(docids);
								jQuery("input[name="+fieldid+"]").val(docids);
								//zhw 20201022 附件上传完后把附件流从表单删除,防止OA的流程处理页面又保存了一次附件流
								jQuery(".filehidediv").remove();
							}
						}
						} catch (e) {
							if (window.console) console.error(e);
						}
					}else{
						alert("附件上传失败:"+data.msg);
					}
					doFromSubmit(formaction);
				},
				error: function(a,b,c){
					alert("请求fileupload失败["+a.responseText+"],["+a.statusText+"],["+b+"],["+c+"]");
					//doFromSubmit(formaction);
					//jQuery("#uploadmsg").html("表单提交中...");
					//$('#workflowfrm').attr("action",formaction).submit();
				}
			});
		}else{
			doFromSubmit(formaction);
			//$('#workflowfrm').attr("action",formaction).submit();
		}
	}catch(e){
		
		//alert("附件上传失败！"+e);
		doFromSubmit(formaction);
		//$('#workflowfrm').attr("action",formaction).submit();
	}
}
//表单提交
function doFromSubmit(formaction){
	if(uploadfields!="" && jQuery("#src").val() != "forward"){
		var haslocalfile = false;
		var parms = "";
		//语音附件文件的处理--暂未开启
		jQuery(".filevoiceids").each(function(){
			var _fieldid = jQuery(this).attr("_fieldid");
			var fileids = "";
			jQuery(".voiceBtn"+_fieldid+"_wxPreviewVoice").each(function(){
				var _fileId = jQuery(this).attr("_fileId");
				if(_fileId!="") fileids += "," + _fileId;
			});
			if(fileids!=""){
				fileids = fileids.substring(1);
				jQuery(this).val(fileids);
				parms += "&filevoice"+_fieldid+"="+fileids;
				haslocalfile = true;
			}
		});
		//图片附件文件的处理
		jQuery(".filephotoids").each(function(){
			var _fieldid = jQuery(this).attr("_fieldid");
			var fileids = "";
			jQuery(".photoBtn"+_fieldid+"_wxPreviewImage").each(function(){
				var _fileId = jQuery(this).attr("_fileId");
				if(_fileId!="") fileids += "," + _fileId;
			});
			if(fileids!=""){
				fileids = fileids.substring(1);
				jQuery(this).val(fileids);
				parms += "&filephoto"+_fieldid+"="+fileids;
				haslocalfile = true;
			}
		});
		
		if (jQuery("#jdyzjjsapi").length > 0) {
			jQuery(".jdyzj_fileIds").each(function(){
				var _fieldid = jQuery(this).attr("_fieldid");
				parms += "&filephoto"+_fieldid+"="+jQuery("#jdyzj_fileIds"+_fieldid).val();
				haslocalfile = true;
			});
		}
		//使用JSAPI上传会走这里的方法,把图片上传到钉钉/微信然后保存到云桥生成云桥的fileid,提交流程的时候先把云桥的附件上传到OA生成OA的fileid在放入表单提交到OA
		if(haslocalfile){
			//alert(parms);
			var workflowid = jQuery("input[name=workflowid]").val();

			jQuery.ajax({
				url:wxcontextpath+"/mobile/plugin/plus/fileupload/uploadOperation.jsp?random="+new Date().getTime(),
				type : "post",
				data : {"operation":"getDocCategory","workflowid":workflowid},
				dataType : "json",
				success : function(data) {
					var docCategory = "";
					if(data.status==0){
						docCategory = data.docCategory;
					}
					var docCategoryParams = "";
					if(docCategory!=""){
						docCategoryParams = "&fieldName="+docCategory+"&"+docCategory+"="+jQuery("#"+docCategory).val();
					}
					jQuery.ajax({
						url : wxcontextpath+"/wxapi/ecfileupload?workflowid="+workflowid+"&uploadfields="+uploadfields+parms+docCategoryParams,
						type : "post",
						dataType : "json",
						success : function(data) {
							//alert(data.status);
							if(data.status==1){
								var values = data.docvaluelist;
								if(values!=null && typeof(values)!="undefined"){
									for(var i=0;i<values.length;i++){
										var fieldid = values[i].fieldid;
										var docids = values[i].docids;
										//alert("下面的方法====="+values[i].fieldid+"--"+values[i].docids);
										if(docids!=""){
											var fieldids = jQuery("#"+fieldid).val();
											if(fieldids=="") fieldids = docids;
											else fieldids += "," + docids;
											jQuery("#"+fieldid).val(fieldids);
											jQuery("input[name="+fieldid+"]").val(fieldids);
										}
									}
								}
							}else{
								alert("附件文件上传失败！");
							}
							workflowfrmSubmit(formaction);
							
						},
						error: function(a,b,c){
							alert("附件文件上传失败,错误原因:"+a+"|"+b+"|"+c);
						}
					});
				},
				error: function(a,b,c){
					alert("请求ecfileupload失败["+a.responseText+"],["+a.statusText+"],["+b+"],["+c+"]");
				}
			});
		}else{
			workflowfrmSubmit(formaction);
		}
	}else{
		workflowfrmSubmit(formaction);
	}
	/*if(uploadfields!=""){
		var uploadids = uploadfields.split(",");
		for(var i=0;i<uploadids.length;i++){
			var fieldid = uploadids[i];
			var ismandfield = jQuery("#"+fieldid).attr("ismandfield");
			if(ismandfield=="1" && jQuery("#"+fieldid).val()==""){
				try{
					$.alert('请填写相关字段!','提示');
				}catch(e){
					alert('请填写相关字段!');
				}
				return;
			}
		}
	}*/
	
}

function workflowfrmSubmit(formaction){
	$('#workflowfrm').attr("action",formaction).ajaxSubmit({
		type : "post",
		dataType : "text",
		success : function(data) {
			data += "<script type='text/javascript' src='"+wxcontextpath+"/main/assets/js/emall.js?20210604'></script>";
			$("html").html(data);
			empl();
			emov();
		}
	});
}

//覆盖掉手机版上传方法
function addAppendix(fieldID){
}

var returnIdField = "";
var returnShowField = "";
var isMuti = ""; 
var _BrowserWindow = window;
var _scrolltop = 0;
var _wheight = 0;
var _wwidth = 0;

var returnIdField_d = "";
var returnShowField_d = "";
var isMuti_d = ""; 

//覆盖选择人员方法
function showDialog(url, data) {
	//alert(data);
	try{
		if(window._isFnaSubmitRequestJs4MobileWf&&
	            ((window.dt1_organizationtype&&window.dt1_organizationid)||
	            (window.dt1_organizationtype2&&window.dt1_organizationid2))
		){//费控流程特殊处理  根据承担主体类型 原有的部门选择可能对应 个人 部门 分部 成本中心
			var paramsArray = data.split("&");
			for (var i=0; i<paramsArray.length; i++) {
				var paramstr = paramsArray[i];
				var paramkv = paramstr.split("=");
				if (paramkv.length > 1) {
					if ("returnIdField" == paramkv[0]) {
						returnIdField = paramkv[1];
					}
				}
			}
	    	var _fieldID = "";
	    	var fieldIDArray = returnIdField.split("_");
	    	if(fieldIDArray!=null){
                if(fieldIDArray.length>=2){
                    _fieldID = fieldIDArray[0].replace("field","");
                }else{
                    _fieldID = fieldIDArray[0].replace("field","");
				}
	    	}
	    	//是费控的选择按钮 调用原始方法
	    	if(_fieldID!=""&&(_fieldID==window.dt1_organizationid || _fieldID==window.dt1_organizationid2)){
	    		showDialogOld(url, data);
	    		return;
	    	}
		}
	}catch(e){
		//alert(e);
	}
	if(data.indexOf("method=listUser")!=-1){
		try{
			if(!hrmBrowserInit){//需要用到的时候加载下
				initHrmBrowser();
			}
			function showListUserEB(){
				//initHrmBrowser();
				//zhw20170620 增加是否限制只查询本分部的人
				var showDept = 0,issubcompany=0;
				//zhw20170928 增加限制选择某些部门的人员
				var deptids = "";
				//zhw20180212 中国铁塔客户二次开发 转办限制人员范围
				var towernodeid = "",toweroperatetype = "";
				//zhw20180416 南京国土客户增加初始指定显示哪个选人标签页
				var showType = "";
				//zhw20180425 中国铁塔客户增加控制人员显示
				var bdf_wfid = "",requestid = "",towersubmit = "";
	            var paramsArray = data.split("&");
				for (var i=0; i<paramsArray.length; i++) {
					var paramstr = paramsArray[i];
					var paramkv = paramstr.split("=");
					if (paramkv.length > 1) {
						if("returnIdField" == paramkv[0]){
							returnIdField = paramkv[1];
						}else if("returnShowField" == paramkv[0]){
							returnShowField = paramkv[1];
						}else if("isMuti" == paramkv[0]){
							isMuti = paramkv[1];
						}else if("showDept" == paramkv[0]){
							showDept = paramkv[1];
						}else if("issubcompany" == paramkv[0]){
							issubcompany = paramkv[1];
						}else if("deptids" == paramkv[0]){
							deptids = paramkv[1];
						}else if("towernodeid" == paramkv[0]){
							towernodeid = paramkv[1];
						}else if("toweroperatetype" == paramkv[0]){
							toweroperatetype = paramkv[1];
						}else if("showType" == paramkv[0]){
							showType = paramkv[1];
						}else if("bdf_wfid" == paramkv[0]){
							bdf_wfid = paramkv[1];
						}else if("requestid" == paramkv[0]){
							requestid = paramkv[1];
						}else if("towersubmit" == paramkv[0]){
							towersubmit = paramkv[1];
						}
					}
				}
				//明细表的人员按钮暂时还是需要使用原始方式
				if(returnIdField.indexOf("_")>-1) {
					showDialogOld(url, data);
					return;
				}
				
				jQuery("#hrmBrowserFrame")[0].contentWindow.resetBrowser({
					"fieldId" : returnIdField,
					"fieldSpanId" : returnShowField,
					"browserType" : (isMuti==1)?1:2,
					"showDept":showDept,
					"showType":showType,
					"deptids":deptids,
					"issubcompany":issubcompany,
					"towernodeid":towernodeid,
					"toweroperatetype":toweroperatetype,
					"towersubmit":towersubmit,
					"bdf_wfid":bdf_wfid,
					"requestid":requestid,
					"selectedIds" : jQuery("#"+returnIdField).val(),
					"callbackBack" : "onHrmBrowserBack_eb",
					"callbackOk" : "onHrmBrowserOk_eb"
				});
				
				//$(document).css({"overflow":"hidden"});
				//jQuery(document.body).css("overflow","hidden");
				_scrolltop = jQuery(document).scrollTop();
				jQuery("#hrmBrowserDiv").animate({ "left":"0" },400,null,function(){
					setTimeout(function(){
						jQuery(document).scrollTop(0);
					},500);
				});
				
				try {
					clearInterval(ckInterval);
				} catch (e){}
				setInterval("setRedflag()",1000);
			}
			if(!hrmFrameInit){
				var hrmFrameInitInterval = setInterval(function(){
					if(hrmFrameInit){
						clearInterval(hrmFrameInitInterval);
						showListUserEB();
					}
				},100);
			}else{
				showListUserEB();
			}
		}catch(e){
			alert(e);
			showDialogOld(url, data);
		}
	}else if(data.indexOf("method=listDepartment")!=-1 || data.indexOf("method=listSubCompany")!=-1){//选择部门 分部
		if(typeof _ifLpkh != "undefined" && _ifLpkh==1&&data.indexOf("method=listDepartment")!=-1){
			try{
				if(!departBrowserInit_lp){//需要用到的时候加载下
					initDepartBrowser_lp();
				}
				function showListDepartEB_lp(){
					var paramsArray = data.split("&");
					for (var i=0; i<paramsArray.length; i++) {
						var paramstr = paramsArray[i];
						var paramkv = paramstr.split("=");
						if (paramkv.length > 1) {
							if("returnIdField" == paramkv[0]){
								returnIdField_d = paramkv[1];
							}else if("returnShowField" == paramkv[0]){
								returnShowField_d = paramkv[1];
							}else if("isMuti" == paramkv[0]){
								isMuti_d = paramkv[1];
							}
						}
					}
					//明细表的人员按钮暂时还是需要使用原始方式
					if(returnIdField_d.indexOf("_")>-1) {
						showDialogOld(url, data);
						return;
					}
					
					jQuery("#departBrowserFrame_eb_lp")[0].contentWindow.resetBrowser({
						"fieldId" : returnIdField_d,
						"fieldSpanId" : returnShowField_d,
						"browserType" : (isMuti_d==1)?1:2,
						"selectType"  : (data.indexOf("method=listDepartment")!=-1)?1:2,
						"selectedIds" : jQuery("#"+returnIdField_d).val(),
						"callbackBack" : "onDepartBrowserBack_eb_lp",
						"callbackOk" : "onDepartBrowserOk_eb_lp"
					});
					
					_scrolltop = jQuery(document).scrollTop();
					jQuery("#departBrowserDiv_lp").animate({ "left":"0" },400,null,function(){
						setTimeout(function(){
							jQuery(document).scrollTop(0);
						},500);
					});
					
					try {
						clearInterval(ckInterval);
					} catch (e){}
					setInterval("setRedflag()",1000);
				}
				if(!departFrameInit_lp){
					var departFrameInitInterval_lp = setInterval(function(){
						if(departFrameInit_lp){
							clearInterval(departFrameInitInterval_lp);
							showListDepartEB_lp();
						}
					},100);
				}else{
					showListDepartEB_lp();
				}
			}catch(e){
				//alert(e);
				showDialogOld(url, data);
			}
		}else{
			try{
				if(!departBrowserInit){//需要用到的时候加载下
					initDepartBrowser();
				}
				function showListDepartEB(){
					var paramsArray = data.split("&");
					for (var i=0; i<paramsArray.length; i++) {
						var paramstr = paramsArray[i];
						var paramkv = paramstr.split("=");
						if (paramkv.length > 1) {
							if("returnIdField" == paramkv[0]){
								returnIdField_d = paramkv[1];
							}else if("returnShowField" == paramkv[0]){
								returnShowField_d = paramkv[1];
							}else if("isMuti" == paramkv[0]){
								isMuti_d = paramkv[1];
							}
						}
					}
					//明细表的人员按钮暂时还是需要使用原始方式
					if(returnIdField_d.indexOf("_")>-1) {
						showDialogOld(url, data);
						return;
					}
					
					jQuery("#departBrowserFrame_eb")[0].contentWindow.resetBrowser({
						"fieldId" : returnIdField_d,
						"fieldSpanId" : returnShowField_d,
						"browserType" : (isMuti_d==1)?1:2,
						"selectType"  : (data.indexOf("method=listDepartment")!=-1)?1:2,
						"selectedIds" : jQuery("#"+returnIdField_d).val(),
						"callbackBack" : "onDepartBrowserBack_eb",
						"callbackOk" : "onDepartBrowserOk_eb"
					});
					
					_scrolltop = jQuery(document).scrollTop();
					jQuery("#departBrowserDiv").animate({ "left":"0" },400,null,function(){
						setTimeout(function(){
							jQuery(document).scrollTop(0);
						},500);
					});
					
					try {
						clearInterval(ckInterval);
					} catch (e){}
					setInterval("setRedflag()",1000);
				}
				if(!departFrameInit){
					var departFrameInitInterval = setInterval(function(){
						if(departFrameInit){
							clearInterval(departFrameInitInterval);
							showListDepartEB();
						}
					},100);
				}else{
					showListDepartEB();
				}
			}catch(e){
				//alert(e);
				showDialogOld(url, data);
			}
		}
	}else{
		showDialogOld(url, data);
	}
}
/*关闭选择人员回调*/
function onHrmBrowserBack_eb(){
	jQuery(document).scrollTop(_scrolltop);
	//jQuery("#hrmBrowserFrame").css("top",_wheight);
	jQuery("#hrmBrowserDiv").animate({ "left":_wwidth*20 },400,null,function(){});
	//initHrmBrowser()
}
/*选择人员确定回调*/
function onHrmBrowserOk_eb(result){
	jQuery('#'+returnShowField).html(result["nameValue"]);
	jQuery('#'+returnIdField).val(result["idValue"]);
	/*if(jQuery('#'+returnIdField+"_d").length>0){
		jQuery('#'+returnIdField+"_d").val(result["idValue"]);
	}
	if(jQuery('#'+returnShowField+"_d").length>0){
		jQuery('#'+returnShowField+"_d").html(result["nameValue"]);
	}*/
	
	//处理字段联动
	if(jQuery('#'+returnIdField).attr("onchange") != ""){
		jQuery('#'+returnIdField).trigger("change");
	}
	
	jQuery(document).scrollTop(_scrolltop);
	//jQuery("#hrmBrowserFrame").css("top",_wheight);
	jQuery("#hrmBrowserDiv").animate({ "left":_wwidth*20 },400,null,function(){});
	
	//流程转发功能特殊处理。
	if("forwardresourceids" == returnIdField){
		try{
			var flag = true;
			if(result["idValue"]!="" && !isNeedAffirmance() && jQuery(".signmenu").length==0){
				flag = confirm("确认进行转发？");
			}
			if(flag){
				closeForwardDialog(true);
			}else{
				jQuery('#'+returnShowField).html("");
				jQuery('#'+returnIdField).val("");
			}
		}catch(e){
			//alert("转发失败:"+e);
			try{
				closeForwardDialog(true);
			}catch(e){
				//alert("转发失败:"+e);
			}
		}
	}
	//征求意见
	else if("forwardresourceids2" == returnIdField){
		try{
			var flag = true;
			if(result["idValue"]!="" && !isNeedAffirmance() && jQuery(".signmenu").length==0){
				flag = confirm("确认进行意见征询？");
			}
			if(flag){
				closeForwardDialog2(true);
			}else{
				jQuery('#'+returnShowField).html("");
				jQuery('#'+returnIdField).val("");
			}
		}catch(e){
			//alert("征求意见失败:"+e);
			try{
				closeForwardDialog2(true);
			}catch(e){
				//alert("征求意见失败:"+e);
			}
		}
	}
	//转办
	else if("forwardresourceids3" == returnIdField){
		try{
			var flag = true;
			if(result["idValue"]!="" && !isNeedAffirmance() && jQuery(".signmenu").length==0){
				flag = confirm("确认进行转办？");
			}
			if(flag){
				closeForwardDialog3(true);
			}else{
				jQuery('#'+returnShowField).html("");
				jQuery('#'+returnIdField).val("");
			}
		}catch(e){
			//alert("转办失败:"+e);
			try{
				closeForwardDialog3(true);
			}catch(e){
				//alert("转办失败:"+e);
			}
		}
	}
	//抄送
	else if("forwardresourceids4" == returnIdField){
		try{
			if(result["idValue"]!=""){
				closeForwardDialog4(true);
			}else{
				jQuery('#'+returnShowField).html("");
				jQuery('#'+returnIdField).val("");
			}
		}catch(e){
			try{
				doforward4(true);
			}catch(e){
				//alert("转办失败:"+e);
			}
		}
	}
	//选择退回节点特殊处理。
	else if("rejectToNodeid" == returnIdField){
		try{
			closeRejectDialog(true);
		}catch(e){
			//alert("退回失败:"+e);
		}
	}
	else if("exceptionoperators" == returnIdField){
		try{
			dynamicHeight_exceptionPage("180px");
		}catch(e){
		}
	}
	//针对东证资管 抄送功能
	else if("Copyresourceids" == returnIdField){
		try{
			closeCopyDialog(true);
		}catch(e){
			//alert("抄送失败:"+e);
		}
	}
	//针对东证资管 会签功能
	else if("huiqian118304" == returnIdField){
		try{
			closeHuiqian118304Dialog(true);
		}catch(e){
			//alert("会签失败:"+e);
		}
	}
}
//选择分部及部门 回调方法
function onDepartBrowserBack_eb(){
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#departBrowserDiv").animate({ "left":_wwidth*20 },400,null,function(){});
}
function onDepartBrowserOk_eb(result){
	jQuery('#'+returnShowField_d).html(result["nameValue"]);
	jQuery('#'+returnIdField_d).val(result["idValue"]);
	
	//处理字段联动
	if(jQuery('#'+returnIdField_d).attr("onchange") != ""){
		jQuery('#'+returnIdField_d).trigger("onchange");
	}
	
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#departBrowserDiv").animate({ "left":_wwidth*20 },400,null,function(){});
}
//选择分部及部门 回调方法 猎聘客户使用
function onDepartBrowserBack_eb_lp(){
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#departBrowserDiv_lp").animate({ "left":_wwidth*20 },400,null,function(){});
}
function onDepartBrowserOk_eb_lp(result){
	jQuery('#'+returnShowField_d).html(result["nameValue"]);
	jQuery('#'+returnIdField_d).val(result["idValue"]);
	
	//处理字段联动
	if(jQuery('#'+returnIdField_d).attr("onchange") != ""){
		jQuery('#'+returnIdField_d).trigger("onchange");
	}
	
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#departBrowserDiv_lp").animate({ "left":_wwidth*20 },400,null,function(){});
}

/*function showDialogOld(url, data) {
	data =joinFieldParams(data);
	
	url = wxcontextpath+"/mobile/plugin/browser.jsp";
	showDialog2(url, data);
}*/

//初始化选择人员控件
function initHrmBrowser(){//zhw 20190826 解决当页面弹出输入法点击选人导致选人DIV不能全屏的问题
	hrmBrowserInit = true;
	_wheight = window.innerHeight;
	_wwidth = window.innerWidth;
	var bstr ="<div id='hrmBrowserLoadDiv' style='width:100%;position:fixed;top:0px;bottom:0px;right:0px;background:#000;overflow:hidden;z-index:10002;opacity:0.5'>"
			+"<div style='position:absolute;top:50%;left:50%;width:100px;margin-left:-50px;height:26px;margin-top:-13px;text-align:center;color:#c5ac36;font-size:18px;'>加载中...</div>"
			+"</div>" 
			+"<div id=\"hrmBrowserDiv\" style=\"width:100%;height:100%;position:fixed;left:"+_wwidth*20+"px;top:0px;bottom:0px;right:0px;background:#fff;overflow:hidden;display: ;z-index:10001;\">"
            + "<iframe id=\"hrmBrowserFrame\" style=\"width:100%;height:100%;\" src=\""+wxcontextpath+"/mobile/plugin/plus/browser/hrmBrowser.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>"
            + "</div>";
	//jQuery("body").append("<iframe id=\"hrmBrowserFrame\" style=\"width:100%;height:"+_wheight+"px;position:fixed;top:"+_wheight+"px;left:0px;right:0px;background:#fff;overflow:hidden;display: ;\" src=\"/mobile/plugin/plus/browser/hrmBrowser.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>");
	jQuery("body").append(bstr);
	$("#hrmBrowserFrame").load(function(){
		hrmFrameInit = true;
		$("#hrmBrowserLoadDiv").hide();
	});
}
//初始化选择部门分部控件
function initDepartBrowser(){
	departBrowserInit = true;
	_wheight = window.innerHeight;
	_wwidth = window.innerWidth;
	var bstr = "<div id=\"departBrowserDiv\" style=\"width:100%;height:"+_wheight+"px;position:fixed;left:"+_wwidth*20+"px;top:0px;bottom:0px;right:0px;background:#fff;overflow:hidden;display: ;z-index:1000;\">"
            + "<iframe id=\"departBrowserFrame_eb\" style=\"width:100%;height:"+_wheight+"px;\" src=\""+wxcontextpath+"/mobile/plugin/plus/browser/departBrowser.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>"
            + "</div>";
	//jQuery("body").append("<iframe id=\"hrmBrowserFrame\" style=\"width:100%;height:"+_wheight+"px;position:fixed;top:"+_wheight+"px;left:0px;right:0px;background:#fff;overflow:hidden;display: ;\" src=\"/mobile/plugin/plus/browser/hrmBrowser.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>");
	jQuery("body").append(bstr);
	$("#departBrowserFrame_eb").load(function(){
		departFrameInit = true;
	});
	
}

//初始化选择部门分部控件 猎聘客户使用
function initDepartBrowser_lp(){
	departBrowserInit_lp = true;
	_wheight = window.innerHeight;
	_wwidth = window.innerWidth;
	var	bstr = "<div id=\"departBrowserDiv_lp\" style=\"width:100%;height:"+_wheight+"px;position:fixed;left:"+_wwidth*20+"px;top:0px;bottom:0px;right:0px;background:#fff;overflow:hidden;display: ;z-index:1000;\">"
        + "<iframe id=\"departBrowserFrame_eb_lp\" style=\"width:100%;height:"+_wheight+"px;\" src=\""+wxcontextpath+"/mobile/plugin/plus/browser/hrmBrowserNewDept.jsp\" frameborder=\"0\" scrolling=\"auto\"></iframe>"
        + "</div>";
	jQuery("body").append(bstr);
	$("#departBrowserFrame_eb_lp").load(function(){
		departFrameInit_lp = true;
	});
	
}

function initFileFrame(){
	var bstr = "<div id=\"fileViewDiv\" style=\"height:"+_wheight+"px;top:"+_wheight*2+"px;\">"
		+ "<iframe id=\"fileViewFrame\" style=\"width:100%;height:"+_wheight+"px;\" src=\"\" frameborder=\"0\" scrolling=\"auto\"></iframe>"
		+ "<div id=\"fileViewClose\" style=\"display:none;\" class=\"dingmenuclose\" onclick=\"closeFileView()\">×</div>"
		+ "</div>";

	jQuery("body").append(bstr);
}

function toDownloadForEb(fid,fname,isopenwin,canDownload) {
	//if(isopenwin){
	//	if(fid) location = "/download.do?fileid="+fid+"&filename="+fname+"&fromWF=true&requestid=" + js_requestid +"&module=" + js_module + "&scope=" + js_scope + "";
	//} else {
		if (_weworkfilepreview == "1") {
			var u = navigator.userAgent;
			var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; // android终端或者uc浏览器
			var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); // ios终端
			if (typeof wx != "undefined" && navigator.userAgent.indexOf("wxwork") != -1 && (isAndroid || isiOS)) {
				jQuery.ajax({
					url : wxcontextpath+"/mobile/plugin/plus/fileupload/getFileSize.jsp",
					type : "post",
					data : {
						"operation" : "getFileSize",
						"fileid" : fid
					},
					dataType : "json",
					success : function(data) {
						if (data.status == 1) {
							alert(data.msg);
							return;
						}
						
						var size = data.fileSize;
						
						jQuery.ajax({
							url : wxcontextpath + "/wxclient/app/outsys/getFileDownloadUrl",
							type : "post",
							data : {
								"fileid" : fid
							},
							dataType : "json",
							success : function(data) {
								if (data.status == "error") {
									alert(data.msg);
									return;
								}
								
								var url = data.downloadurl;
								if (_weworkfilepreviewcache != "1") {
									url += "&r=" + Math.random();
								}
								
								if (typeof _weworkwatermark != "undefined" && _weworkwatermark == 1) {
									wx.invoke("showWatermark", {}, function(res) {
										wx.previewFile({
											url: _outurl + url, // 需要预览文件的地址(必填，可以使用相对路径)
											name: fname, // 需要预览文件的文件名(不填的话取url的最后部分)
											size: size // 需要预览文件的字节大小(必填)
										});
									});
								} else {
									wx.previewFile({
										url: _outurl + url, // 需要预览文件的地址(必填，可以使用相对路径)
										name: fname, // 需要预览文件的文件名(不填的话取url的最后部分)
										size: size // 需要预览文件的字节大小(必填)
									});
								}
								
								$(window).scrollTop(0);
							},
							error : function() {
								alert("获取文件下载路径网络异常");
							}
						});
					},
					error : function() {
						alert("获取文件大小网络异常");
					}
				});
				return;
			}
		} else if (typeof _isNxgszyjsxy != "undefined" && _isNxgszyjsxy == 1 && navigator.userAgent.toUpperCase().indexOf("HUATECHAPP") != -1) {
			jQuery.ajax({
				url : wxcontextpath + "/wxclient/app/outsys/getFileDownloadUrl",
				type : "post",
				data : {
					"fileid" : fid
				},
				dataType : "json",
				success : function(data) {
					if (data.status == "error") {
						alert(data.msg);
						return;
					}
					
					var url = _outurl + data.downloadurl;
					var messageObj = {
						message: 'otherOpenFile',
						fileName: fname,
						downloadUrl: url
					};
					window.top.postMessage(messageObj, '*');
				},
				error : function() {
					alert("获取文件下载路径网络异常");
				}
			});
			return;
		} else if (typeof _isXibujichang != "undefined" && _isXibujichang == 1 && navigator.userAgent.toLowerCase().match(/AppNest/i) == "appnest") {
			if (!isFileDownloading) {
				isFileDownloading = true;
				jQuery.ajax({
					url : wxcontextpath + "/wxclient/app/outsys/getFileDownloadUrl",
					type : "post",
					data : {
						"fileid" : fid
					},
					dataType : "json",
					success : function(data) {
						if (data.status == "error") {
							alert(data.msg);
							isFileDownloading = false;
							return;
						}
						
						appnest.http.download({
							url: _outurl + data.downloadurl,
							method: 'post',
							path: 'res:download/',
							success: function(msg) {
								appnest.native.openFile({
									path: msg.path //需要打开本地文件地址路径，支持全路径或res:前缀路径
								});
								isFileDownloading = false;
							},
							fail: function(err) {
								alert(err);
								isFileDownloading = false;
							}
						});
					},
					error : function() {
						alert("获取文件下载路径网络异常");
						isFileDownloading = false;
					}
				});
			} else {
				alert("正在下载文件，请耐心等待！");
			}
			return;
		} else if (typeof _isCaiTongZhengQuan != "undefined" && _isCaiTongZhengQuan == 1) {
			if (!isFileDownloading) {
				isFileDownloading = true;
				jQuery.ajax({
					url : wxcontextpath+"/mobile/plugin/plus/fileupload/getFileSize.jsp",
					type : "post",
					data : {
						"operation" : "getFileSize",
						"fileid" : fid
					},
					dataType : "json",
					success : function(data) {
						if (data.status == 1) {
							alert(data.msg);
							return;
						}
						
						var size = data.fileSize;
						
						jQuery.ajax({
							url : wxcontextpath + "/wxclient/app/outsys/getFileDownloadUrl",
							type : "post",
							data : {
								"fileid" : fid
							},
							dataType : "json",
							success : function(data) {
								if (data.status == "error") {
									alert(data.msg);
									isFileDownloading = false;
									return;
								}
								
								ub.nav.client.openfile({
									data:{
										url: _outurl + data.downloadurl,
										fileName: fname,
										fileSize: size
									}
								});
								isFileDownloading = false;
							},
							error : function() {
								alert("获取文件下载路径网络异常");
								isFileDownloading = false;
							}
						});
					},
					error : function() {
						alert("获取文件大小网络异常");
					}
				});
			} else {
				alert("正在下载文件，请耐心等待！");
			}
			return;
		}
		
		fname = encodeURIComponent(fname);// 含有%等特殊字符字段手机端下载不了问题，url前端无法解析，encode 下。
		var downloadUrl = wxcontextpath + "/download.do?download=1&fileid="+fid+"&filename="+fname+"&canDownload="+canDownload;
		if(typeof _ifHrzq != "undefined" && _ifHrzq==1 && fname.indexOf(".pdf")>-1){
			downloadUrl = downloadUrl+"&file2pdf=1";
		}
		location.href = downloadUrl;
//		_scrolltop = jQuery(document).scrollTop();
//		jQuery("#fileViewFrame").attr("src","/download.do?download=1&fileid="+fid+"&filename="+fname);
//		jQuery("#fileViewFrame").bind("load",function(){
//			jQuery("#fileViewClose").show();
//			jQuery("#fileViewDiv").animate({ "top":"0" },400,null,function(){
//				setTimeout(function(){
//					jQuery(document).scrollTop(0);
//				},500);
//			});
//		});
		//window.open("/download.do?download=1&fileid="+fid+"&filename="+fname,'_blank');
	//}
}
function closeFileView(){
	jQuery(document).scrollTop(_scrolltop);
	jQuery("#fileViewFrame").unbind("load");
	jQuery("#fileViewClose").hide();
	jQuery("#fileViewDiv").animate({ "top":_wheight*2 },400,null,function(){});
	jQuery("#fileViewFrame").attr("src","");
}

/********************************以下为钉钉功能**************************************************/

//初始化钉钉功能菜单
function initDingMenu(){
	if(_isZTKD == 1){_str_name = "DING"}
	var menustr = 
		 "<div id=\"dingmenubtn\" style=\"width:50px;height:50px;border-radius:25px;line-height:50px;position:fixed;right:10px;bottom:120px;background:#0080C0;color:#fff;text-align:center;font-size:20px;z-index:10;cursor:pointer;\""
			+" onclick=\"\" _isopen=\"0\">"+_str_name+"</div>"
			+"<div id=\"dingmenuinfo\" class=\"dingmenuinfo\">"
			+"	<div id=\"dingmenuusers\" style=\"\">";
	if(jsapitype=="dd" || jsapitype=="dd_pc"){
		menustr += "  	<div class=\"dduser_head\"><div class=\"dduser_titlename2\">通讯录</div><div class=\"dduser_add\" onclick=\"openDingContact()\">+</div><div class=\"dduser_clear\" onclick=\"clearDingContact()\">-</div></div>"
				 + "  	<div id=\"dduser_list\" class=\"dduser_list\"></div>"
	}
		
	menustr	+="  	<div class=\"dduser_head\"><div class=\"dduser_titlename2\">流程相关</div></div>"
			+"	</div>"
		
			+"	<div id=\"dingmenubtns\" class=\"dingmenubtns\">";
	if(jsapitype=="dd"){
		menustr	+="		<div class=\"ddmenubtn\" onclick=\"doDingM()\"><img class=\"ddmenuicon\" src=\""+wxcontextpath+"/main/assets/img/msg.png\"/>发消息</div>"
				+"		<div class=\"ddmenuline\">|</div>"
				+"		<div class=\"ddmenubtn\" onclick=\"doDingC()\"><img class=\"ddmenuicon\" src=\""+wxcontextpath+"/main/assets/img/phone.png\"/>免费电话</div>"
				+"		<div class=\"ddmenuline\">|</div>"
				+"		<div class=\"ddmenubtn\" onclick=\"doDingD()\"><img class=\"ddmenuicon\" src=\""+wxcontextpath+"/main/assets/img/ding.png\"/>DING一下</div>"
				
	}else if(jsapitype=="dd_pc"){
		menustr	+="		<div class=\"wxmenubtn\" onclick=\"doDingD()\"><img class=\"ddmenuicon\" src=\""+wxcontextpath+"/main/assets/img/ding.png\"/>DING一下</div>"
		
	}else if(jsapitype=="wx"){
		menustr	+="		<div class=\"wxmenubtn\" onclick=\"doWXM()\"><img class=\"ddmenuicon\" src=\""+wxcontextpath+"/main/assets/img/msg.png\"/>发送微信消息</div>"
	}
		
	menustr	+="	</div>"
			+"  <div id=\"dingmenuclose\" class=\"dingmenuclose\" onclick=\"closeDingMenu()\">×</div>"
			+"	<div id=\"ddgotop\" class=\"ddgotop\" onclick=\"doGoTop()\">^</div>"
			+"</div>"
			;
	jQuery("body").append(menustr);
	try{
		//可拖动按钮
		var dx, dy,offx,offy;var dragged = false;
		touch.on('#dingmenubtn', 'touchstart', function(ev){
			ev.preventDefault();
		});
		touch.on('#dingmenubtn', 'touchend', function(ev){
			if(dragged) return;
			openDingMenu();//20190826 zhw 解决钉钉PC版 会触发两次点击事件的问题
		});
		touch.on('#dingmenubtn', 'drag', function(ev){
			jQuery("#dingmenubtn").css({
				"transition-duration":"0s",
				"-moz-transition-duration":"0s",
				"-webkit-transition-duration":"0s",
				"-o-transition-duration":"0s"
			});
			dx = dx || 0;
			dy = dy || 0;
			offx = dx + ev.x;
			offy = dy + ev.y;
			//log("dx:" + dx + ", dy:" + dy +"<br/>ev.x:"+ev.x+",ev.y:"+ev.y+"<br/>offx:"+offx+",offy:"+offy);
			var dHeight = document.body.clientHeight-70;
			if(Math.abs(offy)>dHeight) offy = 0-dHeight;
			if(offy>0) offy = 0;
			var dWidth = document.body.clientWidth-60;
			if(Math.abs(offx)>dWidth) offx = 0-dWidth;
			if(offx>0) offx = 0;
			this.style.webkitTransform = "translate3d(" + offx + "px," + offy + "px,0)";
			if(Math.abs(offx)>10||Math.abs(offy)>10)
				dragged = true;
		});
		touch.on('#dingmenubtn', 'dragend', function(ev){
			jQuery("#dingmenubtn").css({
				"transition-duration":"0.5s",
				"-moz-transition-duration":"0.5s",
				"-webkit-transition-duration":"0.5s",
				"-o-transition-duration":"0.5s"
			});
			this.style.webkitTransform = "translate3d(0px," + offy + "px,0)";
			dx = 0;
			dy += ev.y;
			dragged = false;
		});
		//var div = "<div id=\"dtext\" style=\"width:200px;height:200px;position:fixed;right:10px;bottom:80px;z-index:9;background:#0080C0;color:#fff;\"></div>";
		//jQuery("body").append(div);
	}catch(e){
		//alert(e);
	}
	//setTimeout(function(){//zhw 20190227修改 不要立即加载盯人员信息 防止用户感觉页面加载慢
	//	getWFUsers();
	//},3000);
}
function log(str){
	jQuery("#dtext").html(str);
}
function getWFUsers(){
	jQuery.ajax({
		//url : wxcontextpath+"/mobile/plugin/plus/workflow/data/workflowOperation.jsp",
		url : wxcontextpath+"/wxclient/app/outsys/getWFUsers",
		type : "post",
		data : {
			"operation" : "getWFUsers",
			"topsize" : "100",
			"syscorpid" : dd_corpId,
			"requestid" : _requestid
		},
		dataType : "json",
		success : function(data) {
			if(data.status==0){
				var userstr = "";
				if(data.creater){
					userstr += "<div class=\"dduser_title\"><img class=\"dduser_checkall\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/><div class=\"dduser_titlename\">创建人</div></div>";
					userstr += "<div class=\"dduser_item\" _usertag=\""+data.creater.usertag+"\">"
						+"<img class=\"dduser_check\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/>"
						+"<div class=\"dduser_iteminfo\">"
						+"<img class=\"dduser_himg\" src=\""+data.creater.imgurl+"\"/>"
						+"<div class=\"dduser_itemname\">"+data.creater.username+"</div><div class=\"dduser_itemjob\">"+data.creater.jobtitle+"</div>"
						+"<div class=\"dduser_itemsub\">"+data.creater.subcompany+"</div><div class=\"dduser_itemdepart\">"+data.creater.depart+"</div>"
						+"</div>"
						+"</div>";
				}
				if(data.operators2){
					userstr += "<div class=\"dduser_title\"><img class=\"dduser_checkall\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/><div class=\"dduser_titlename\">未操作者</div></div>";
					for(var i=0;i<data.operators2.length;i++){
						userstr += "<div class=\"dduser_item\" _usertag=\""+data.operators2[i].usertag+"\">"
						+"<img class=\"dduser_check\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/>"
						+"<div class=\"dduser_iteminfo\">"
						+"<img class=\"dduser_himg\" src=\""+data.operators2[i].imgurl+"\"/>"
						+"<div class=\"dduser_itemname\">"+data.operators2[i].username+"</div><div class=\"dduser_itemjob\">"+data.operators2[i].jobtitle+"</div>"
						+"<div class=\"dduser_itemsub\">"+data.operators2[i].subcompany+"</div><div class=\"dduser_itemdepart\">"+data.operators2[i].depart+"</div>"
						+"</div>"
						+"</div>";
					}
				}
				
				if(data.operators1){
					userstr += "<div class=\"dduser_title\"><img class=\"dduser_checkall\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/><div class=\"dduser_titlename\">已操作者</div></div>";
					for(var i=0;i<data.operators1.length;i++){
						userstr += "<div class=\"dduser_item\" _usertag=\""+data.operators1[i].usertag+"\">"
						+"<img class=\"dduser_check\" src=\""+wxcontextpath+"/main/assets/img/checkoff.png\"/>"
						+"<div class=\"dduser_iteminfo\">"
						+"<img class=\"dduser_himg\" src=\""+data.operators1[i].imgurl+"\"/>"
						+"<div class=\"dduser_itemname\">"+data.operators1[i].username+"</div><div class=\"dduser_itemjob\">"+data.operators1[i].jobtitle+"</div>"
						+"<div class=\"dduser_itemsub\">"+data.operators1[i].subcompany+"</div><div class=\"dduser_itemdepart\">"+data.operators1[i].depart+"</div>"
						+"</div>"
						+"</div>";
					}
				}
				if(data.hasmore && data.hasmore==1){
					userstr += "<div class=\"dduser_more\">...</div>";
				}
				jQuery("#dingmenuusers").append(userstr);
				
				jQuery("div.dduser_title").unbind("click");
				jQuery("div.dduser_title").bind("click",function(){
					var dduser_check = jQuery(this).find(".dduser_checkall");
					if(dduser_check.hasClass("dduser_checkall_checked")){
						dduser_check.removeClass("dduser_checkall_checked").attr("src",wxcontextpath+"/main/assets/img/checkoff.png");
						jQuery(this).nextUntil("div.dduser_title","div.dduser_item").children(".dduser_check").removeClass("dduser_checked").attr("src",wxcontextpath+"/main/assets/img/checkoff.png");
					}else{
						dduser_check.addClass("dduser_checkall_checked").attr("src",wxcontextpath+"/main/assets/img/checkon.png");
						jQuery(this).nextUntil("div.dduser_title","div.dduser_item").children(".dduser_check").addClass("dduser_checked").attr("src",wxcontextpath+"/main/assets/img/checkon.png");
					}
				});
				
				jQuery("div.dduser_item").unbind("click");
				
				jQuery("div.dduser_item").bind("click",function(){
					var dduser_check = jQuery(this).find(".dduser_check");
					if(dduser_check.hasClass("dduser_checked")){
						dduser_check.removeClass("dduser_checked").attr("src",wxcontextpath+"/main/assets/img/checkoff.png");
					}else{
						dduser_check.addClass("dduser_checked").attr("src",wxcontextpath+"/main/assets/img/checkon.png");
					}
				});
				
				jQuery("#dingmenuusers").bind("scroll",function(){
					if(jQuery(this).scrollTop()>50){
						jQuery("#ddgotop").show();
					}else{
						jQuery("#ddgotop").hide();
					}
				});
			}else{
				alert(data.msg);
			}
		},
		error : function() {
			jQuery("#dingmenubtn").hide();
		},
		complete:function(){
			dingMenuInit = true;
		}
	});
}
var dingMenuInit = false;
function openDingMenu(){
	//jQuery("#view_page").hide();
	if(!dingMenuInit){//zhw 20190313 修改 点击盯功能的时候才去加载 盯的人员信息
		getWFUsers();
	}
	jQuery("#dingmenuinfo").fadeIn(200);
	//jQuery('html, body').css("overflow","hidden");
	//myScroll.refresh();
}
function closeDingMenu(){
	//jQuery("#view_page").show();
	jQuery("#dingmenuinfo").fadeOut(200);
	//jQuery('html, body').css("overflow","auto");
}
function doGoTop(){
	jQuery("#dingmenuusers").scrollTop(0);
}
//打开钉钉通讯录
function openDingContact(){
	var users=new Array();
	var _index = 0;
	jQuery(".dduser_item2").each(function(){
		var usertag = jQuery(this).attr("_usertag");
		if(usertag!=""){
			users[_index] = usertag;
			_index++;
		}
	});
	
	ddobj.biz.contact.choose({
	    multiple: true, //是否多选： true多选 false单选； 默认true
	    users: users, //默认选中的用户列表，工号；成功回调中应包含该信息
	    corpId: dd_corpId, //企业id
	    max: 50, //人数限制，当multiple为true才生效，可选范围1-1500
	    onSuccess : function(result) {
	    	if(result.length>0){
	    		var ulist = "";
	    		for(var i=0;i<result.length;i++){
	    			ulist += "<div class=\"dduser_item2\" _usertag=\""+result[i].emplId+"\"><div class=\"dduser_name\">"+result[i].name+"</div><div class=\"dduser_del\" onclick=\"deldduser(this)\">×</div></div>"
		    	}
	    		jQuery("#dduser_list").html(ulist);
	    	}
	        
	        /*[{
	            emplId: '0573', //工号
	            name: '张三', //姓名
	            nickNameCn: '三张', //花名
	            mobilePhone: '****', //手机号 后续不再返回该字段
	            emailAddr: '***', //邮箱  后期不再返回该字段
	            pinyin: 'zhangsan', //姓名拼音
	            avatar: 'htp://g.alicdn.com/avatar/zhangsan.png' //头像图片url，可能为空
	        }]*/
	        
	    },
	    onFail : function(err) {}
	});
	
}
function deldduser(obj){
	jQuery(obj).parent("div.dduser_item2").remove();
}
//清除选择人员
function clearDingContact(){
	if(jQuery("div.dduser_item2").length>0){
		ddobj.device.notification.confirm({
		    message: "确定清除已选择人员？",
		    title: "",
		    buttonLabels: ['确认', '取消'],
		    onSuccess : function(result) {
		    	if(result.buttonIndex==0){
		    		jQuery("div.dduser_item2").remove();
		    	}
		    },
		    onFail : function(err) {}
		});
	}
}

//获取选中的用户
function makeUsers(){
	var users=new Array();
	var _index = 0;
	jQuery(".dduser_item2").each(function(){
		var usertag = jQuery(this).attr("_usertag");
		if(usertag!=""){
			users[_index] = usertag;
			_index++;
		}
	});
	jQuery(".dduser_checked").each(function(){
		var itemobj = jQuery(this).parent("div.dduser_item");
		var usertag = itemobj.attr("_usertag");
		if(usertag!=""){
			users[_index] = usertag;
			_index++;
		}
	});
	return users;
}
//获取选中的用户(微信拼接)
function makeUsers2(){
	var users="";
	jQuery(".dduser_item2").each(function(){
		var usertag = jQuery(this).attr("_usertag");
		if(usertag!=""){
			users += ";" + usertag;
		}
	});
	jQuery(".dduser_checked").each(function(){
		var itemobj = jQuery(this).parent("div.dduser_item");
		var usertag = itemobj.attr("_usertag");
		if(usertag!=""){
			users += ";" + usertag;
		}
	});
	if(users!="") users = users.substring(1);
	return users;
}

var browser = {
	versions: function () {
		var u = navigator.userAgent, app = navigator.appVersion;
		return { //移动终端浏览器版本信息 
			ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端 
			android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或uc浏览器 
			iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器 
			iPad: u.indexOf('iPad') > -1, //是否iPad 
			WindowsWechat: u.indexOf('WindowsWechat') > -1, //是否企业微信PC版
		};
	}(),
}

Date.prototype.format = function(format) {
	var o = {
		"M+" : this.getMonth() + 1, // month
		"d+" : this.getDate(), // day
		"h+" : this.getHours(), // hour
		"m+" : this.getMinutes(), // minute
		"s+" : this.getSeconds(), // second
		"q+" : Math.floor((this.getMonth() + 3) / 3), // quarter
		"S" : this.getMilliseconds()
	// millisecond
	}

	if (/(y+)/.test(format)) {
		format = format.replace(RegExp.$1, (this.getFullYear() + "")
				.substr(4 - RegExp.$1.length));
	}

	for ( var k in o) {
		if (new RegExp("(" + k + ")").test(format)) {
			format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k]
					: ("00" + o[k]).substr(("" + o[k]).length));
		}
	}
	return format;
}

//解决钉钉PC端无法下载PDF附件
function toDownload(fid,fname,isopenwin,canDownload) {//zhw 20190918 增加参数canDownload控制是否允许下载该附件
	//zhw 20180614 钉钉PC版的PDF也走在线预览功能
	toDownloadForEb(fid,fname,isopenwin,canDownload);
//	try{
//		if(typeof DingTalkPC != "undefined" && fname.indexOf(".pdf")>-1){
//			var nfname = encodeURIComponent(fname);
//			DingTalkPC.biz.util.downloadFile({
//			    url: _outurl + "/download.do?fileid="+fid+"&filename="+nfname+"&eb_filedownload=1", //要下载的文件的url
//			    name: fname, //定义下载文件名字
//			    onProgress: function(msg){
//			      // 文件下载进度回调
//			    },
//			    onSuccess : function(result) {
//			    },
//			    onFail : function(error) {
//			    	toDownloadForEb(fid,fname,isopenwin);
//			    }
//			})
//		}else{
//			toDownloadForEb(fid,fname,isopenwin);
//		}
//	}catch(e){
//		toDownloadForEb(fid,fname,isopenwin);
//	}
}

function delJZYZJFile(id, fieldid) {
	var jdyzj_fileIds = jQuery("#jdyzj_fileIds"+fieldid).val();
	jdyzj_fileIds = jdyzj_fileIds.replace("," + id, "").replace(id + ",", "").replace(id, "");
	jQuery("#jdyzj_fileIds"+fieldid).val(jdyzj_fileIds);
	$("#jdyzj_fileshowitem" + id).remove();
}

function wxPreviewImage(imgObj, imgurl) {
	var _imgurl = _outurl + imgurl;
	if (_photopreviewmode == "1") {
		location.href = _imgurl;
		
		imgObj.one("click", function() {
			wxPreviewImage(jQuery(this), imgurl);
		});
		
		return;
	}
	
	var items = [];
	var currentIndex = 0;
	for (var i = 0; i < imgurls.length; i++) {
		if (imgurls[i] == _imgurl) {
			currentIndex = i;
		}
	}
	
	handleImageWidthHeight(items, imgurls, 0, currentIndex, function() {
		imgObj.one("click", function() {
			wxPreviewImage(jQuery(this), imgurl);
		});
	});
}

function handleImageWidthHeight(items, imgurls, i, currentIndex, callback) {
	var img = new Image();
	img.src = imgurls[i];

	// 如果图片被缓存，则直接返回缓存数据
	if (img.complete) {
		var zoom = img.width > screen.width ? (screen.width / img.width - 0.001) : 1;
		items.push({
			src: imgurls[i],
			w: img.width * zoom,
			h: img.height * zoom
		});
		
		if (i == imgurls.length - 1) {
			var option = {
				index: currentIndex,
				pinchToClose: false,
				maxSpreadZoom: 5,
				closeOnVerticalDrag: false
			};
			new PhotoSwipe(document.querySelectorAll(".pswp")[0], PhotoSwipeUI_Default, items, option).init();
			callback();
		} else {
			handleImageWidthHeight(items, imgurls, ++i, currentIndex, callback);
		}
	} else {
		// 完全加载完毕的事件
		img.onload = function() {
			var zoom = img.width > screen.width ? (screen.width / img.width - 0.001) : 1;
			items.push({
				src: imgurls[i],
				w: img.width * zoom,
				h: img.height * zoom
			});
			
			if (i == imgurls.length - 1) {
				var option = {
					index: currentIndex,
					pinchToClose: false,
					maxSpreadZoom: 5,
					closeOnVerticalDrag: false
				};
				new PhotoSwipe(document.querySelectorAll(".pswp")[0], PhotoSwipeUI_Default, items, option).init();
				callback();
			} else {
				handleImageWidthHeight(items, imgurls, ++i, currentIndex, callback);
			}
		}
	}
}
